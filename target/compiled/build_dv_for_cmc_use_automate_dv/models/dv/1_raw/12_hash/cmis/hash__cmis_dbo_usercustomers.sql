
-- Generated by AutomateDV (formerly known as dbtvault)

    

WITH source_data AS (

    SELECT

    ID,
    UserID,
    CustomerID,
    AccountType,
    CreatedDate,
    CreatedByID,
    CreatedByName,
    ModifiedDate,
    ModifiedByID,
    ModifiedByName,
    Activate,
    GroupID,
    RequestAccountID,
    SendMailed,
    ReasonDeactive,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE

    FROM "DWH"."dbo"."stg__cmis_dbo_usercustomers"
),

derived_columns AS (

    SELECT

    ID,
    UserID,
    CustomerID,
    AccountType,
    CreatedDate,
    CreatedByID,
    CreatedByName,
    ModifiedDate,
    ModifiedByID,
    ModifiedByName,
    Activate,
    GroupID,
    RequestAccountID,
    SendMailed,
    ReasonDeactive,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    DV_RECORD_SOURCE AS dv_recordsource,
    cast( [DV_APPLIED_DATE] as DATETIME2(6)) AS dv_load_timestamp,
    UserID AS user_code,
    CustomerID AS customer_code,
    'default' AS dv_tenant_id,
    'default' AS dv_collisioncode,
    ID AS dv_cdk_l_user_customer

    FROM source_data
),

hashed_columns AS (

    SELECT

    ID,
    UserID,
    CustomerID,
    AccountType,
    CreatedDate,
    CreatedByID,
    CreatedByName,
    ModifiedDate,
    ModifiedByID,
    ModifiedByName,
    Activate,
    GroupID,
    RequestAccountID,
    SendMailed,
    ReasonDeactive,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    dv_recordsource,
    dv_load_timestamp,
    user_code,
    customer_code,
    dv_tenant_id,
    dv_collisioncode,
    dv_cdk_l_user_customer,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(customer_code AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^')), 2) AS dv_hash_key_h_customer,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(user_code AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^')), 2) AS dv_hash_key_h_user,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(user_code AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(customer_code AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_cdk_l_user_customer AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^||^^||^^')), 2) AS dv_hash_key_l_user_customer,

    CONVERT(CHAR(32), HASHBYTES('MD5', CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(AccountType AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(Activate AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(GroupID AS VARCHAR(MAX)))), ''), '^^')
    )), 2) AS dv_hashdiff_s_l_user_customer,

    CONVERT(CHAR(32), HASHBYTES('MD5', ISNULL(NULLIF(UPPER(TRIM(CAST(DV_APPLIED_DATE AS VARCHAR(MAX)))), ''), '^^')), 2) AS dv_hashdiff_s_l_user_customer_rt

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    ID,
    UserID,
    CustomerID,
    AccountType,
    CreatedDate,
    CreatedByID,
    CreatedByName,
    ModifiedDate,
    ModifiedByID,
    ModifiedByName,
    Activate,
    GroupID,
    RequestAccountID,
    SendMailed,
    ReasonDeactive,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    dv_recordsource,
    dv_load_timestamp,
    user_code,
    customer_code,
    dv_tenant_id,
    dv_collisioncode,
    dv_cdk_l_user_customer,
    dv_hash_key_h_customer,
    dv_hash_key_h_user,
    dv_hash_key_l_user_customer,
    dv_hashdiff_s_l_user_customer,
    dv_hashdiff_s_l_user_customer_rt

    FROM hashed_columns
)

SELECT * FROM columns_to_select