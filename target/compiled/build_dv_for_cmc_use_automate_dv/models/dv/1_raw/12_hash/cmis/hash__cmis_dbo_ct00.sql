
-- Generated by AutomateDV (formerly known as dbtvault)

    

WITH source_data AS (

    SELECT

    stt_rec,
    ma_dvcs,
    loai_ct,
    ma_ct,
    ngay_ct,
    ngay_lct,
    so_ct,
    so_ctgs,
    ngay_ctgs,
    so_lo,
    ngay_lo,
    ong_ba,
    head_item,
    dien_giai_h,
    dien_giai,
    nh_dk,
    tk,
    tk_du,
    ps_no_nt,
    ps_co_nt,
    ma_nt,
    ty_gia,
    ps_no,
    ps_co,
    ma_kh,
    ma_vv,
    ma_nk,
    ma_sp,
    ma_bp,
    so_lsx,
    so_ct0,
    ngay_ct0,
    ct_nxt,
    ma_gd,
    nam,
    ky,
    gt_no,
    gt_co,
    gt_tinh,
    gt_dd,
    sua_tg_yn,
    line_nbr,
    status,
    datetime0,
    datetime2,
    user_id0,
    user_id2,
    ma_hd,
    ma_ku,
    ma_phi,
    so_dh,
    ma_td1,
    ma_td2,
    ma_td3,
    sl_td1,
    sl_td2,
    sl_td3,
    ngay_td1,
    ngay_td2,
    ngay_td3,
    gc_td1,
    gc_td2,
    gc_td3,
    s1,
    s2,
    s3,
    s4,
    s5,
    s6,
    s7,
    s8,
    s9,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE

    FROM "DWH"."dbo"."stg__cmis_dbo_ct00"
),

derived_columns AS (

    SELECT

    stt_rec,
    ma_dvcs,
    loai_ct,
    ma_ct,
    ngay_ct,
    ngay_lct,
    so_ct,
    so_ctgs,
    ngay_ctgs,
    so_lo,
    ngay_lo,
    ong_ba,
    head_item,
    dien_giai_h,
    dien_giai,
    nh_dk,
    tk,
    tk_du,
    ps_no_nt,
    ps_co_nt,
    ma_nt,
    ty_gia,
    ps_no,
    ps_co,
    ma_kh,
    ma_vv,
    ma_nk,
    ma_sp,
    ma_bp,
    so_lsx,
    so_ct0,
    ngay_ct0,
    ct_nxt,
    ma_gd,
    nam,
    ky,
    gt_no,
    gt_co,
    gt_tinh,
    gt_dd,
    sua_tg_yn,
    line_nbr,
    status,
    datetime0,
    datetime2,
    user_id0,
    user_id2,
    ma_hd,
    ma_ku,
    ma_phi,
    so_dh,
    ma_td1,
    ma_td2,
    ma_td3,
    sl_td1,
    sl_td2,
    sl_td3,
    ngay_td1,
    ngay_td2,
    ngay_td3,
    gc_td1,
    gc_td2,
    gc_td3,
    s1,
    s2,
    s3,
    s4,
    s5,
    s6,
    s7,
    s8,
    s9,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    DV_RECORD_SOURCE AS dv_recordsource,
    cast( DV_APPLIED_DATE as DATETIME2(6)) AS dv_load_timestamp,
    ma_vv AS opportunity_code,
    stt_rec AS invoice_code,
    line_nbr AS dv_cdk_l_opportunity_invoice,
    'default' AS dv_tenant_id,
    'default' AS dv_collisioncode

    FROM source_data
),

hashed_columns AS (

    SELECT

    stt_rec,
    ma_dvcs,
    loai_ct,
    ma_ct,
    ngay_ct,
    ngay_lct,
    so_ct,
    so_ctgs,
    ngay_ctgs,
    so_lo,
    ngay_lo,
    ong_ba,
    head_item,
    dien_giai_h,
    dien_giai,
    nh_dk,
    tk,
    tk_du,
    ps_no_nt,
    ps_co_nt,
    ma_nt,
    ty_gia,
    ps_no,
    ps_co,
    ma_kh,
    ma_vv,
    ma_nk,
    ma_sp,
    ma_bp,
    so_lsx,
    so_ct0,
    ngay_ct0,
    ct_nxt,
    ma_gd,
    nam,
    ky,
    gt_no,
    gt_co,
    gt_tinh,
    gt_dd,
    sua_tg_yn,
    line_nbr,
    status,
    datetime0,
    datetime2,
    user_id0,
    user_id2,
    ma_hd,
    ma_ku,
    ma_phi,
    so_dh,
    ma_td1,
    ma_td2,
    ma_td3,
    sl_td1,
    sl_td2,
    sl_td3,
    ngay_td1,
    ngay_td2,
    ngay_td3,
    gc_td1,
    gc_td2,
    gc_td3,
    s1,
    s2,
    s3,
    s4,
    s5,
    s6,
    s7,
    s8,
    s9,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    dv_recordsource,
    dv_load_timestamp,
    opportunity_code,
    invoice_code,
    dv_cdk_l_opportunity_invoice,
    dv_tenant_id,
    dv_collisioncode,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(opportunity_code AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^')), 2) AS dv_hash_key_h_opportunity,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(invoice_code AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^')), 2) AS dv_hash_key_h_invoice,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(invoice_code AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(opportunity_code AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_cdk_l_opportunity_invoice AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^||^^||^^')), 2) AS dv_hash_key_l_opportunity_invoice,

    CONVERT(CHAR(32), HASHBYTES('MD5', CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST([ngay_ct] AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST([ps_co] AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST([ps_no] AS VARCHAR(MAX)))), ''), '^^')
    )), 2) AS dv_hashdiff_s_l_opportunity_invoice

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    stt_rec,
    ma_dvcs,
    loai_ct,
    ma_ct,
    ngay_ct,
    ngay_lct,
    so_ct,
    so_ctgs,
    ngay_ctgs,
    so_lo,
    ngay_lo,
    ong_ba,
    head_item,
    dien_giai_h,
    dien_giai,
    nh_dk,
    tk,
    tk_du,
    ps_no_nt,
    ps_co_nt,
    ma_nt,
    ty_gia,
    ps_no,
    ps_co,
    ma_kh,
    ma_vv,
    ma_nk,
    ma_sp,
    ma_bp,
    so_lsx,
    so_ct0,
    ngay_ct0,
    ct_nxt,
    ma_gd,
    nam,
    ky,
    gt_no,
    gt_co,
    gt_tinh,
    gt_dd,
    sua_tg_yn,
    line_nbr,
    status,
    datetime0,
    datetime2,
    user_id0,
    user_id2,
    ma_hd,
    ma_ku,
    ma_phi,
    so_dh,
    ma_td1,
    ma_td2,
    ma_td3,
    sl_td1,
    sl_td2,
    sl_td3,
    ngay_td1,
    ngay_td2,
    ngay_td3,
    gc_td1,
    gc_td2,
    gc_td3,
    s1,
    s2,
    s3,
    s4,
    s5,
    s6,
    s7,
    s8,
    s9,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    dv_recordsource,
    dv_load_timestamp,
    opportunity_code,
    invoice_code,
    dv_cdk_l_opportunity_invoice,
    dv_tenant_id,
    dv_collisioncode,
    dv_hash_key_h_opportunity,
    dv_hash_key_h_invoice,
    dv_hash_key_l_opportunity_invoice,
    dv_hashdiff_s_l_opportunity_invoice

    FROM hashed_columns
)

SELECT * FROM columns_to_select