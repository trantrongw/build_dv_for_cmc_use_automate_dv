
-- Generated by AutomateDV (formerly known as dbtvault)

    

WITH source_data AS (

    SELECT

    ID,
    Code,
    OrderID,
    OrderCode,
    SolutionBranchID,
    SolutionBranchNameID,
    ProductBranchID,
    VendorBranchID,
    ProductName,
    VATTypeID,
    PartNumber,
    Warranty,
    BeginDateWarranty,
    EndDateWarranty,
    Description,
    UnitName,
    Quantity,
    Tax,
    Price,
    TotalBeforeVAT,
    TotalVAT,
    TotalAfterVAT,
    CreatedDate,
    NameSolutionBranchID,
    NameSolutionBranchNameID,
    NameProductBranchID,
    NameVendorBranchID,
    NameVATTypeID,
    RetailTypeID,
    RetailConfigID,
    IsService,
    IsHardware,
    STTMis,
    GroupID,
    IsMain,
    ParentID,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE

    FROM "DWH"."dbo"."stg__cmis_dbo_orderdetails"
),

derived_columns AS (

    SELECT

    ID,
    Code,
    OrderID,
    OrderCode,
    SolutionBranchID,
    SolutionBranchNameID,
    ProductBranchID,
    VendorBranchID,
    ProductName,
    VATTypeID,
    PartNumber,
    Warranty,
    BeginDateWarranty,
    EndDateWarranty,
    Description,
    UnitName,
    Quantity,
    Tax,
    Price,
    TotalBeforeVAT,
    TotalVAT,
    TotalAfterVAT,
    CreatedDate,
    NameSolutionBranchID,
    NameSolutionBranchNameID,
    NameProductBranchID,
    NameVendorBranchID,
    NameVATTypeID,
    RetailTypeID,
    RetailConfigID,
    IsService,
    IsHardware,
    STTMis,
    GroupID,
    IsMain,
    ParentID,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    DV_RECORD_SOURCE AS dv_recordsource,
    cast( DV_APPLIED_DATE as DATETIME2(6)) AS dv_load_timestamp,
    cast( SolutionBranchID as VARCHAR(4000)) AS product_code,
    cast(OrderID as VARCHAR(8000)) AS order_code,
    ID AS dv_cdk_l_orderdetail,
    'default' AS dv_tenant_id,
    'default' AS dv_collisioncode

    FROM source_data
),

hashed_columns AS (

    SELECT

    ID,
    Code,
    OrderID,
    OrderCode,
    SolutionBranchID,
    SolutionBranchNameID,
    ProductBranchID,
    VendorBranchID,
    ProductName,
    VATTypeID,
    PartNumber,
    Warranty,
    BeginDateWarranty,
    EndDateWarranty,
    Description,
    UnitName,
    Quantity,
    Tax,
    Price,
    TotalBeforeVAT,
    TotalVAT,
    TotalAfterVAT,
    CreatedDate,
    NameSolutionBranchID,
    NameSolutionBranchNameID,
    NameProductBranchID,
    NameVendorBranchID,
    NameVATTypeID,
    RetailTypeID,
    RetailConfigID,
    IsService,
    IsHardware,
    STTMis,
    GroupID,
    IsMain,
    ParentID,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    dv_recordsource,
    dv_load_timestamp,
    product_code,
    order_code,
    dv_cdk_l_orderdetail,
    dv_tenant_id,
    dv_collisioncode,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(order_code AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^')), 2) AS dv_hash_key_h_order,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(product_code AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^')), 2) AS dv_hash_key_h_product,

    CONVERT(CHAR(32), HASHBYTES('MD5', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_cdk_l_orderdetail AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(order_code AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST(product_code AS VARCHAR(MAX)))), ''), '^^')
    ), '^^||^^||^^||^^||^^')), 2) AS dv_hash_key_l_orderdetail,

    CONVERT(CHAR(32), HASHBYTES('MD5', CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST([IsMain] AS VARCHAR(MAX)))), ''), '^^'), '||',
        ISNULL(NULLIF(UPPER(TRIM(CAST([TotalBeforeVAT] AS VARCHAR(MAX)))), ''), '^^')
    )), 2) AS dv_hashdiff_s_l_orderdetail

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    ID,
    Code,
    OrderID,
    OrderCode,
    SolutionBranchID,
    SolutionBranchNameID,
    ProductBranchID,
    VendorBranchID,
    ProductName,
    VATTypeID,
    PartNumber,
    Warranty,
    BeginDateWarranty,
    EndDateWarranty,
    Description,
    UnitName,
    Quantity,
    Tax,
    Price,
    TotalBeforeVAT,
    TotalVAT,
    TotalAfterVAT,
    CreatedDate,
    NameSolutionBranchID,
    NameSolutionBranchNameID,
    NameProductBranchID,
    NameVendorBranchID,
    NameVATTypeID,
    RetailTypeID,
    RetailConfigID,
    IsService,
    IsHardware,
    STTMis,
    GroupID,
    IsMain,
    ParentID,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    dv_recordsource,
    dv_load_timestamp,
    product_code,
    order_code,
    dv_cdk_l_orderdetail,
    dv_tenant_id,
    dv_collisioncode,
    dv_hash_key_h_order,
    dv_hash_key_h_product,
    dv_hash_key_l_orderdetail,
    dv_hashdiff_s_l_orderdetail

    FROM hashed_columns
)

SELECT * FROM columns_to_select