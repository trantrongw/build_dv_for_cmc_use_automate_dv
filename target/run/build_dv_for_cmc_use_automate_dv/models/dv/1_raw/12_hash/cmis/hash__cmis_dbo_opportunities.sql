
    

    EXEC('create view "dbo"."hash__cmis_dbo_opportunities__dbt_tmp" as 
-- Generated by AutomateDV (formerly known as dbtvault)

    

WITH source_data AS (

    SELECT

    ID,
    Code,
    CustomerID,
    SaleManID,
    OpportunityType,
    GroupID,
    EstimateRevenue,
    Description,
    StatusID,
    PublishType,
    Activate,
    IsDeleted,
    CreatedDate,
    CreatedByID,
    CreatedByName,
    ModifiedDate,
    ModifiedByID,
    ModifiedByName,
    ParentID,
    BusinessOpportunityID,
    CustomerName,
    BaseSource,
    LastUpdateBase,
    ParentIndex,
    IsParent,
    IsLockFinance,
    ExpiryDate,
    FinancialYear,
    CustomerCode,
    SaleManUserName,
    SaleManFullName,
    GroupCode,
    GroupName,
    EstimateRevenueExist,
    Common,
    ProductManagerID,
    ProductManagerUserName,
    ProductManagerFullName,
    IsFinish,
    BoxmovingType,
    OrderID,
    Url,
    IsSync,
    DateSync,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE

    FROM "DWH"."dbo"."stg__cmis_dbo_opportunities"
),

derived_columns AS (

    SELECT

    ID,
    Code,
    CustomerID,
    SaleManID,
    OpportunityType,
    GroupID,
    EstimateRevenue,
    Description,
    StatusID,
    PublishType,
    Activate,
    IsDeleted,
    CreatedDate,
    CreatedByID,
    CreatedByName,
    ModifiedDate,
    ModifiedByID,
    ModifiedByName,
    ParentID,
    BusinessOpportunityID,
    CustomerName,
    BaseSource,
    LastUpdateBase,
    ParentIndex,
    IsParent,
    IsLockFinance,
    ExpiryDate,
    FinancialYear,
    CustomerCode,
    SaleManUserName,
    SaleManFullName,
    GroupCode,
    GroupName,
    EstimateRevenueExist,
    Common,
    ProductManagerID,
    ProductManagerUserName,
    ProductManagerFullName,
    IsFinish,
    BoxmovingType,
    OrderID,
    Url,
    IsSync,
    DateSync,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    DV_RECORD_SOURCE AS dv_recordsource,
    cast( DV_APPLIED_DATE as DATETIME2(6)) AS dv_load_timestamp,
    cast(ID as VARCHAR(8000)) AS opportunity_code,
    cast(CustomerID as VARCHAR(8000)) AS customer_code,
    cast(SaleManID as VARCHAR(8000)) AS user_code,
    cast(GroupID as VARCHAR(8000)) AS department_code,
    ''default'' AS dv_tenant_id,
    ''default'' AS dv_collisioncode

    FROM source_data
),

hashed_columns AS (

    SELECT

    ID,
    Code,
    CustomerID,
    SaleManID,
    OpportunityType,
    GroupID,
    EstimateRevenue,
    Description,
    StatusID,
    PublishType,
    Activate,
    IsDeleted,
    CreatedDate,
    CreatedByID,
    CreatedByName,
    ModifiedDate,
    ModifiedByID,
    ModifiedByName,
    ParentID,
    BusinessOpportunityID,
    CustomerName,
    BaseSource,
    LastUpdateBase,
    ParentIndex,
    IsParent,
    IsLockFinance,
    ExpiryDate,
    FinancialYear,
    CustomerCode,
    SaleManUserName,
    SaleManFullName,
    GroupCode,
    GroupName,
    EstimateRevenueExist,
    Common,
    ProductManagerID,
    ProductManagerUserName,
    ProductManagerFullName,
    IsFinish,
    BoxmovingType,
    OrderID,
    Url,
    IsSync,
    DateSync,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    dv_recordsource,
    dv_load_timestamp,
    opportunity_code,
    customer_code,
    user_code,
    department_code,
    dv_tenant_id,
    dv_collisioncode,

    CONVERT(CHAR(32), HASHBYTES(''MD5'', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(opportunity_code AS VARCHAR(MAX)))), ''''), ''^^'')
    ), ''^^||^^||^^'')), 2) AS dv_hash_key_h_opportunity,

    CONVERT(CHAR(32), HASHBYTES(''MD5'', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(customer_code AS VARCHAR(MAX)))), ''''), ''^^'')
    ), ''^^||^^||^^'')), 2) AS dv_hash_key_h_customer,

    CONVERT(CHAR(32), HASHBYTES(''MD5'', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(user_code AS VARCHAR(MAX)))), ''''), ''^^'')
    ), ''^^||^^||^^'')), 2) AS dv_hash_key_h_user,

    CONVERT(CHAR(32), HASHBYTES(''MD5'', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(department_code AS VARCHAR(MAX)))), ''''), ''^^'')
    ), ''^^||^^||^^'')), 2) AS dv_hash_key_h_department,

    CONVERT(CHAR(32), HASHBYTES(''MD5'', NULLIF(CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_tenant_id AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(dv_collisioncode AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(opportunity_code AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(customer_code AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(user_code AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST(department_code AS VARCHAR(MAX)))), ''''), ''^^'')
    ), ''^^||^^||^^||^^||^^||^^'')), 2) AS dv_hash_key_l_opportunity_customer_user_department,

    CONVERT(CHAR(32), HASHBYTES(''MD5'', CONCAT(
        ISNULL(NULLIF(UPPER(TRIM(CAST([Activate] AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST([BusinessOpportunityID] AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST([CreatedDate] AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST([EstimateRevenue] AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST([IsDeleted] AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST([OpportunityType] AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST([ParentID] AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST([PublishType] AS VARCHAR(MAX)))), ''''), ''^^''), ''||'',
        ISNULL(NULLIF(UPPER(TRIM(CAST([StatusID] AS VARCHAR(MAX)))), ''''), ''^^'')
    )), 2) AS dv_hashdiff_s_h_opportunity

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    ID,
    Code,
    CustomerID,
    SaleManID,
    OpportunityType,
    GroupID,
    EstimateRevenue,
    Description,
    StatusID,
    PublishType,
    Activate,
    IsDeleted,
    CreatedDate,
    CreatedByID,
    CreatedByName,
    ModifiedDate,
    ModifiedByID,
    ModifiedByName,
    ParentID,
    BusinessOpportunityID,
    CustomerName,
    BaseSource,
    LastUpdateBase,
    ParentIndex,
    IsParent,
    IsLockFinance,
    ExpiryDate,
    FinancialYear,
    CustomerCode,
    SaleManUserName,
    SaleManFullName,
    GroupCode,
    GroupName,
    EstimateRevenueExist,
    Common,
    ProductManagerID,
    ProductManagerUserName,
    ProductManagerFullName,
    IsFinish,
    BoxmovingType,
    OrderID,
    Url,
    IsSync,
    DateSync,
    DV_RECORD_SOURCE,
    DV_APPLIED_DATE,
    dv_recordsource,
    dv_load_timestamp,
    opportunity_code,
    customer_code,
    user_code,
    department_code,
    dv_tenant_id,
    dv_collisioncode,
    dv_hash_key_h_opportunity,
    dv_hash_key_h_customer,
    dv_hash_key_h_user,
    dv_hash_key_h_department,
    dv_hash_key_l_opportunity_customer_user_department,
    dv_hashdiff_s_h_opportunity

    FROM hashed_columns
)

SELECT * FROM columns_to_select;');

